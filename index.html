<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0b0f">
<title>DECODE ‚Äî Crack the System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ============================
   RESET & VARIABLES
   ============================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0b0b0f;
  --bg-raise: #131318;
  --bg-card: #18181f;
  --bg-card-hover: #1e1e27;
  --bg-input: #111116;
  --border: #2a2a35;
  --border-lit: #3a3a48;
  --text: #eaeaf0;
  --text-mid: #9898a8;
  --text-dim: #5c5c6e;
  --lime: #c8ff00;
  --lime-soft: rgba(200, 255, 0, 0.12);
  --lime-mid: rgba(200, 255, 0, 0.25);
  --cyan: #00d4ff;
  --cyan-soft: rgba(0, 212, 255, 0.12);
  --red: #ff3b5c;
  --red-soft: rgba(255, 59, 92, 0.12);
  --green: #00e676;
  --green-soft: rgba(0, 230, 118, 0.12);
  --orange: #ff9100;
  --orange-soft: rgba(255, 145, 0, 0.12);
  --r: 10px;
  --r-lg: 14px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --font-display: 'Bebas Neue', sans-serif;
  --font-body: 'Outfit', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.55;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* ============================
   NOISE TEXTURE OVERLAY
   ============================ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0;
}

/* ============================
   HEADER
   ============================ */
.hdr {
  position: sticky; top: 0; z-index: 100;
  background: rgba(11,11,15,0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 1rem;
  height: 56px;
  display: flex; align-items: center;
}

.hdr-inner {
  width: 100%; max-width: 960px; margin: 0 auto;
  display: flex; align-items: center; justify-content: space-between;
}

.hdr-brand {
  display: flex; align-items: center; gap: 0.5rem;
  cursor: pointer;
}

.hdr-logo {
  font-family: var(--font-display);
  font-size: 1.7rem;
  letter-spacing: 0.08em;
  color: var(--lime);
  line-height: 1;
}

.hdr-tag {
  font-size: 0.6rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-dim);
  background: var(--bg-raise);
  border: 1px solid var(--border);
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
  display: none;
}

@media (min-width: 400px) { .hdr-tag { display: block; } }

.hdr-actions {
  display: flex; align-items: center; gap: 0.35rem;
}

/* ============================
   BUTTONS
   ============================ */
.btn {
  font-family: var(--font-body);
  font-weight: 600; font-size: 0.78rem;
  padding: 0.45rem 0.85rem;
  border-radius: var(--r);
  border: 1.5px solid transparent;
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex; align-items: center; gap: 0.35rem;
  text-decoration: none; white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(0.97); }

.btn-lime { background: var(--lime); color: #0b0b0f; border-color: var(--lime); font-weight: 700; }
.btn-lime:hover { box-shadow: 0 0 20px rgba(200,255,0,0.25); }
.btn-ghost { background: transparent; color: var(--text-mid); border-color: var(--border); }
.btn-ghost:hover { border-color: var(--lime); color: var(--lime); }
.btn-icon {
  background: transparent; border: none; color: var(--text-dim);
  padding: 0.4rem; border-radius: var(--r); cursor: pointer;
  font-size: 1.1rem; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.btn-icon:hover { color: var(--lime); background: var(--lime-soft); }
.btn-sm { font-size: 0.72rem; padding: 0.35rem 0.65rem; }

/* ============================
   LANDING PAGE
   ============================ */
.land {
  max-width: 720px; margin: 0 auto;
  padding: 2rem 1rem 3rem;
  position: relative; z-index: 1;
}

.land-hero {
  text-align: center;
  margin-bottom: 2.5rem;
  padding-top: 0.5rem;
}

.land-title {
  font-family: var(--font-display);
  font-size: clamp(3rem, 12vw, 5.5rem);
  letter-spacing: 0.06em;
  line-height: 0.9;
  color: var(--lime);
  margin-bottom: 0.4rem;
  text-shadow: 0 0 60px rgba(200,255,0,0.15);
}

.land-sub {
  font-size: 0.95rem;
  color: var(--text-mid);
  font-weight: 400;
  max-width: 400px;
  margin: 0 auto;
}

.land-sub strong { color: var(--text); font-weight: 600; }

/* Section labels */
.sec-label {
  font-family: var(--font-mono);
  font-size: 0.65rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.14em;
  color: var(--lime);
  margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.6rem;
}

.sec-label::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--border), transparent);
}

/* Preset cards */
.preset-list {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.6rem;
  margin-bottom: 2rem;
}

@media (min-width: 520px) {
  .preset-list { grid-template-columns: repeat(2, 1fr); }
}

.preset {
  background: var(--bg-card);
  border: 1.5px solid var(--border);
  border-radius: var(--r-lg);
  padding: 1rem 1rem 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}

.preset::after {
  content: ''; position: absolute;
  inset: 0; border-radius: var(--r-lg);
  background: linear-gradient(135deg, rgba(200,255,0,0.04) 0%, transparent 50%);
  opacity: 0; transition: opacity 0.2s;
  pointer-events: none;
}

.preset:hover { border-color: var(--lime); transform: translateY(-2px); }
.preset:hover::after { opacity: 1; }
.preset:active { transform: translateY(0) scale(0.99); }

.preset-icon {
  font-size: 1.6rem;
  margin-bottom: 0.4rem;
  display: block;
}

.preset-name {
  font-family: var(--font-display);
  font-size: 1.25rem;
  letter-spacing: 0.04em;
  line-height: 1.15;
  margin-bottom: 0.25rem;
}

.preset-desc {
  font-size: 0.75rem;
  color: var(--text-dim);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.preset-chips {
  display: flex; gap: 0.4rem; flex-wrap: wrap;
}

.chip {
  font-family: var(--font-mono);
  font-size: 0.58rem; font-weight: 600;
  padding: 0.18rem 0.45rem;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.chip-lime { background: var(--lime-soft); color: var(--lime); }
.chip-cyan { background: var(--cyan-soft); color: var(--cyan); }

.preset.coming {
  opacity: 0.35; pointer-events: none;
  filter: grayscale(0.5);
}

/* Upload bar */
.upload-bar {
  background: var(--bg-raise);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 0.75rem 1rem;
  display: flex; align-items: center; gap: 0.75rem;
}

.upload-bar-text {
  flex: 1; min-width: 0;
}

.upload-bar-text strong {
  font-size: 0.8rem; display: block;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.upload-bar-text span {
  font-size: 0.68rem; color: var(--text-dim);
}

.upload-btn {
  flex-shrink: 0;
  background: var(--bg-card); border: 1.5px dashed var(--border);
  border-radius: var(--r); padding: 0.4rem 0.9rem;
  cursor: pointer; transition: all 0.15s;
  font-family: var(--font-body); font-size: 0.75rem;
  font-weight: 600; color: var(--text-mid);
  -webkit-tap-highlight-color: transparent;
}
.upload-btn:hover { border-color: var(--lime); color: var(--lime); }

/* ============================
   MAIN APP
   ============================ */
.app { max-width: 960px; margin: 0 auto; padding: 1rem 0.75rem 6rem; position: relative; z-index: 1; }

@media (min-width: 520px) { .app { padding: 1.25rem 1rem 6rem; } }

/* System header */
.sys-head { margin-bottom: 1.25rem; }

.sys-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 5vw, 2.2rem);
  letter-spacing: 0.04em;
  line-height: 1;
  margin-bottom: 0.3rem;
}

.sys-desc {
  font-size: 0.82rem;
  color: var(--text-mid);
  line-height: 1.5;
  max-width: 600px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* XP Bar */
.xp-bar {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.6rem 0.75rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  margin-bottom: 1rem;
}

.xp-label {
  font-family: var(--font-mono);
  font-size: 0.65rem; font-weight: 700;
  color: var(--lime);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  white-space: nowrap;
}

.xp-track {
  flex: 1; height: 6px;
  background: var(--bg-input);
  border-radius: 3px; overflow: hidden;
}

.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--lime), #e0ff66);
  border-radius: 3px;
  transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1);
  box-shadow: 0 0 8px rgba(200,255,0,0.3);
}

.xp-pct {
  font-family: var(--font-mono);
  font-size: 0.7rem; font-weight: 700;
  color: var(--lime);
  white-space: nowrap;
  min-width: 32px; text-align: right;
}

/* Level strip */
.lvl-strip {
  display: flex; gap: 0.4rem;
  margin-bottom: 1.25rem;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding-bottom: 2px;
}
.lvl-strip::-webkit-scrollbar { display: none; }

.lvl-pill {
  flex-shrink: 0;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  border: 1.5px solid var(--border);
  background: var(--bg-card);
  cursor: pointer; transition: all 0.15s;
  font-family: var(--font-body);
  font-size: 0.75rem; font-weight: 600;
  color: var(--text-mid);
  display: flex; align-items: center; gap: 0.4rem;
  -webkit-tap-highlight-color: transparent;
}
.lvl-pill:hover { border-color: var(--text-mid); }
.lvl-pill.active {
  background: var(--lime);
  border-color: var(--lime);
  color: #0b0b0f;
  font-weight: 700;
}

.lvl-num {
  font-family: var(--font-display);
  font-size: 1rem; line-height: 1;
}

.lvl-info {
  padding: 0.6rem 0.75rem;
  background: var(--lime-soft);
  border-radius: var(--r);
  border-left: 3px solid var(--lime);
  font-size: 0.78rem;
  color: var(--lime);
  margin-bottom: 1.25rem;
  line-height: 1.5;
  word-wrap: break-word;
}

/* ============================
   COMPONENT CARDS
   ============================ */
.cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
}

@media (min-width: 640px) {
  .cards { grid-template-columns: repeat(2, 1fr); }
}

.card {
  background: var(--bg-card);
  border: 1.5px solid var(--border);
  border-radius: var(--r-lg);
  overflow: hidden;
  transition: border-color 0.2s;
}
.card:hover { border-color: var(--border-lit); }
.card.done { border-color: var(--green); }

.card-top {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.55rem 0.75rem;
  background: var(--bg-raise);
  border-bottom: 1px solid var(--border);
}

.card-num {
  font-family: var(--font-mono);
  font-size: 0.65rem; font-weight: 700;
  color: var(--lime);
}

.card-badge {
  font-family: var(--font-mono);
  font-size: 0.55rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.08em;
  padding: 0.15rem 0.45rem;
  border-radius: 4px;
}
.badge-todo { color: var(--text-dim); background: rgba(92,92,110,0.15); }
.badge-wip { color: var(--orange); background: var(--orange-soft); }
.badge-done { color: var(--green); background: var(--green-soft); }

.card-body {
  padding: 0.75rem;
}

/* Image area */
.img-zone {
  margin-bottom: 0.75rem;
  border-radius: var(--r);
  overflow: hidden;
  border: 1.5px dashed var(--border);
  position: relative;
  min-height: 120px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-input);
  cursor: pointer; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.img-zone:hover { border-color: var(--lime); }
.img-zone.has-img { border-style: solid; border-color: var(--border); min-height: auto; }

.img-zone img {
  width: 100%; height: auto; display: block;
  max-height: 220px; object-fit: cover;
}

.img-empty {
  text-align: center; padding: 1.2rem 0.5rem;
  color: var(--text-dim);
}
.img-empty-ico { font-size: 1.5rem; margin-bottom: 0.3rem; }
.img-empty-txt { font-size: 0.72rem; font-weight: 500; }

.img-tag {
  position: absolute; top: 0.4rem; right: 0.4rem;
  background: var(--cyan); color: #0b0b0f;
  font-size: 0.55rem; font-weight: 800;
  padding: 0.12rem 0.4rem; border-radius: 4px;
  text-transform: uppercase; letter-spacing: 0.04em;
}

.img-rm {
  position: absolute; bottom: 0.4rem; right: 0.4rem;
  background: rgba(11,11,15,0.85); border: 1px solid var(--border);
  color: var(--text-mid); border-radius: var(--r);
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 0.8rem;
  -webkit-tap-highlight-color: transparent;
}
.img-rm:hover { color: var(--red); border-color: var(--red); }

/* Fields */
.fld { margin-bottom: 0.65rem; }
.fld:last-child { margin-bottom: 0; }

.fld-label {
  display: flex; align-items: center; gap: 0.35rem;
  font-size: 0.65rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--text-dim);
  margin-bottom: 0.3rem;
}

.fld-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--red); flex-shrink: 0;
}

.fld-badge {
  font-size: 0.5rem; font-weight: 800;
  padding: 0.08rem 0.35rem; border-radius: 3px;
  background: var(--cyan-soft); color: var(--cyan);
  text-transform: uppercase; letter-spacing: 0.04em;
}

.fld-input {
  width: 100%;
  background: var(--bg-input);
  border: 1.5px solid var(--border);
  border-radius: var(--r);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 0.82rem;
  padding: 0.55rem 0.65rem;
  transition: all 0.15s;
  resize: vertical;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.fld-input:focus {
  outline: none;
  border-color: var(--lime);
  box-shadow: 0 0 0 3px var(--lime-soft);
}
.fld-input.prov {
  background: var(--cyan-soft);
  border-color: rgba(0,212,255,0.2);
  color: var(--text);
  font-size: 0.78rem;
  line-height: 1.5;
}
.fld-input::placeholder { color: var(--text-dim); }
textarea.fld-input { min-height: 60px; }

.hint-btn {
  font-size: 0.7rem; font-weight: 600;
  color: var(--lime); background: none; border: none;
  cursor: pointer; font-family: var(--font-body);
  margin-top: 0.25rem; padding: 0;
  display: inline-flex; align-items: center; gap: 0.25rem;
  -webkit-tap-highlight-color: transparent;
}
.hint-btn:hover { text-decoration: underline; }

.hint-box {
  margin-top: 0.25rem; padding: 0.4rem 0.6rem;
  background: var(--lime-soft); border-radius: var(--r);
  border-left: 2px solid var(--lime);
  font-size: 0.75rem; color: var(--lime);
  line-height: 1.45;
  display: none;
  word-wrap: break-word;
}
.hint-box.on { display: block; }

/* ============================
   BOTTOM ACTION BAR
   ============================ */
.bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(11,11,15,0.94);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-top: 1px solid var(--border);
  padding: 0.6rem 0.75rem calc(0.6rem + var(--safe-bottom));
  z-index: 100;
  display: none;
}
.bar.on { display: block; }

.bar-inner {
  max-width: 960px; margin: 0 auto;
  display: flex; align-items: center;
  justify-content: space-between; gap: 0.5rem;
}

.bar-stat {
  font-family: var(--font-mono);
  font-size: 0.68rem; font-weight: 600;
  color: var(--text-dim);
}
.bar-stat b { color: var(--lime); }

.bar-btns { display: flex; gap: 0.35rem; }

/* ============================
   REVIEW PANEL
   ============================ */
.review {
  background: var(--bg-card);
  border: 1.5px solid var(--green);
  border-radius: var(--r-lg);
  padding: 1.25rem;
  margin-top: 1.5rem;
  display: none;
}
.review.on { display: block; }

.review-hd {
  font-family: var(--font-display);
  font-size: 1.4rem; letter-spacing: 0.04em;
  color: var(--green); margin-bottom: 0.75rem;
}

.review-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.review-stat {
  background: var(--bg-input);
  border-radius: var(--r);
  padding: 0.6rem 0.5rem;
  text-align: center;
}

.review-val {
  font-family: var(--font-display);
  font-size: 1.6rem; line-height: 1;
  color: var(--lime);
}

.review-lbl {
  font-size: 0.6rem; font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-top: 0.2rem;
}

/* ============================
   TOAST
   ============================ */
.toast {
  position: fixed; bottom: 5rem; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--bg-card); border: 1.5px solid var(--lime);
  color: var(--lime); padding: 0.55rem 1rem;
  border-radius: 50px; font-weight: 600; font-size: 0.78rem;
  z-index: 200; transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  pointer-events: none; white-space: nowrap;
  box-shadow: 0 4px 24px rgba(200,255,0,0.12);
}
.toast.on { transform: translateX(-50%) translateY(0); }

/* ============================
   MODAL
   ============================ */
.modal-bg {
  position: fixed; inset: 0;
  background: rgba(11,11,15,0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 300;
  display: flex; align-items: flex-end; justify-content: center;
  padding: 0;
  opacity: 0; pointer-events: none;
  transition: opacity 0.2s;
}
.modal-bg.on { opacity: 1; pointer-events: all; }

@media (min-width: 520px) {
  .modal-bg { align-items: center; padding: 1rem; }
}

.modal-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg) var(--r-lg) 0 0;
  width: 100%;
  max-height: 85dvh; overflow-y: auto;
  padding: 1.25rem;
  transform: translateY(20px);
  transition: transform 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}
.modal-bg.on .modal-box { transform: translateY(0); }

@media (min-width: 520px) {
  .modal-box {
    max-width: 440px;
    border-radius: var(--r-lg);
  }
}

.modal-box h3 {
  font-family: var(--font-display);
  font-size: 1.3rem; letter-spacing: 0.04em;
  margin-bottom: 0.75rem;
}

/* ============================
   PRINT
   ============================ */
.print-only { display: none; }
.no-print {}

@media print {
  * { color: #000 !important; background: #fff !important; border-color: #bbb !important; box-shadow: none !important; }
  body::before { display: none; }
  .hdr, .bar, .hint-btn, .img-rm, .no-print { display: none !important; }
  .print-only { display: block !important; }
  .app { padding: 0 !important; max-width: none; }
  .cards { grid-template-columns: 1fr !important; gap: 0.5rem !important; }
  .card { break-inside: avoid; page-break-inside: avoid; border: 1.5pt solid #000 !important; }
  .fld-input { border: 1px solid #999 !important; min-height: 40px !important; background: #f8f8f8 !important; }
  .fld-input.prov { background: #e6f3ff !important; }
  textarea.fld-input { min-height: 65px !important; }
  .img-zone { min-height: 100px !important; border: 1.5pt solid #999 !important; }
  .print-hd { text-align: center; border-bottom: 2pt solid #000; padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
  .print-hd h1 { font-size: 1.4rem; }
  .print-meta { display: flex; justify-content: space-between; font-size: 0.85rem; margin-top: 0.5rem; }
  body { font-size: 10pt; }
}

/* ============================
   ANIMATIONS
   ============================ */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
.anim { animation: slideUp 0.35s ease forwards; opacity: 0; }
.card:nth-child(1) { animation-delay: 0.03s; }
.card:nth-child(2) { animation-delay: 0.06s; }
.card:nth-child(3) { animation-delay: 0.09s; }
.card:nth-child(4) { animation-delay: 0.12s; }
.card:nth-child(5) { animation-delay: 0.15s; }
.card:nth-child(6) { animation-delay: 0.18s; }
.card:nth-child(7) { animation-delay: 0.21s; }
.card:nth-child(8) { animation-delay: 0.24s; }
.card:nth-child(n+9) { animation-delay: 0.27s; }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-inner">
    <div class="hdr-brand" onclick="backToMenu()">
      <span class="hdr-logo">DECODE</span>
      <span class="hdr-tag">CRACK THE SYSTEM</span>
    </div>
    <div class="hdr-actions" id="hdrActions" style="display:none;">
      <button class="btn-icon" onclick="showLevelModal()" title="Change level">‚öô</button>
      <button class="btn-icon" onclick="window.print()" title="Print worksheet">üñ®</button>
      <button class="btn-icon" onclick="saveProgress()" title="Save progress">üíæ</button>
    </div>
  </div>
</header>

<!-- LANDING -->
<div id="landing" class="land">
  <div class="land-hero">
    <div class="land-title">DECODE</div>
    <p class="land-sub"><strong>Crack the system.</strong> Identify components, snap photos, describe how things work.</p>
  </div>

  <div class="sec-label">Select a system</div>
  <div class="preset-list" id="presetList"></div>

  <div class="upload-bar" id="uploadBar">
    <span style="font-size:1.2rem;">üìÅ</span>
    <div class="upload-bar-text">
      <strong>Load a custom system</strong>
      <span>Drop or browse a JSON file</span>
    </div>
    <button class="upload-btn" onclick="document.getElementById('fileIn').click()">Browse</button>
    <input type="file" id="fileIn" accept=".json" style="display:none" onchange="loadFile(event)">
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none;">
  <div class="app">
    <!-- Print header -->
    <div class="print-only print-hd">
      <h1 id="printTitle">Component Worksheet</h1>
      <div class="print-meta">
        <span>Name: ___________________________</span>
        <span>Date: ______________</span>
        <span>Level: <span id="printLvl">1</span></span>
      </div>
    </div>

    <div class="sys-head" id="sysHead"></div>
    <div class="xp-bar no-print" id="xpBar"></div>
    <div class="lvl-strip no-print" id="lvlStrip"></div>
    <div class="lvl-info no-print" id="lvlInfo" style="display:none;"></div>
    <div class="cards" id="cards"></div>
    <div class="review" id="review">
      <div class="review-hd">‚úì RESULTS</div>
      <div class="review-grid" id="reviewGrid"></div>
      <button class="btn btn-lime btn-sm" onclick="exportResults()">üìã Export</button>
    </div>
  </div>
</div>

<!-- BOTTOM BAR -->
<div class="bar" id="bar">
  <div class="bar-inner">
    <div class="bar-stat" id="barStat"><b>0</b> / 0</div>
    <div class="bar-btns">
      <button class="btn btn-ghost btn-sm" onclick="resetAnswers()">Clear</button>
      <button class="btn btn-lime btn-sm" onclick="checkAnswers()">‚úì Check</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LEVEL MODAL -->
<div class="modal-bg" id="lvlModal">
  <div class="modal-box" id="lvlModalBox"></div>
</div>

<script>
/* ============================================
   PRESET CONFIG ‚Äî ADD NEW SYSTEMS HERE
   ============================================ */
const PRESETS = [
  {
    file: 'transmission-system.json',
    icon: '‚öô',
    title: 'Transmission System',
    desc: 'Clutch, gearbox, propshaft, differential, driveshafts, CV joints and more',
    count: 18
  }
  // {
  //   file: 'braking-system.json',
  //   icon: 'üõë',
  //   title: 'Braking System',
  //   desc: 'Disc brakes, drum brakes, master cylinder, ABS and hydraulic circuits',
  //   count: 14
  // },
  // {
  //   file: 'engine-systems.json',
  //   icon: 'üèé',
  //   title: 'Engine Systems',
  //   desc: 'Cylinder block, pistons, crankshaft, camshaft, valvetrain and lubrication',
  //   count: 16
  // },
];

const PLACEHOLDERS = [
  { icon: 'üõë', title: 'Braking System' },
  { icon: 'üèé', title: 'Engine Systems' },
  { icon: '‚ö°', title: 'Electrical System' },
];

/* ============================================
   STATE
   ============================================ */
const S = { data: null, level: 1, inputs: {} };

/* ============================================
   RENDER PRESETS
   ============================================ */
function renderPresets() {
  const el = document.getElementById('presetList');
  let h = PRESETS.map(p => `
    <div class="preset" onclick="loadPreset('${p.file}')">
      <span class="preset-icon">${p.icon}</span>
      <div class="preset-name">${p.title}</div>
      <div class="preset-desc">${p.desc}</div>
      <div class="preset-chips">
        <span class="chip chip-lime">${p.count} parts</span>
        <span class="chip chip-cyan">3 levels</span>
      </div>
    </div>
  `).join('');

  const need = Math.max(0, 3 - PRESETS.length);
  h += PLACEHOLDERS.slice(0, need).map(p => `
    <div class="preset coming">
      <span class="preset-icon">${p.icon}</span>
      <div class="preset-name">${p.title}</div>
      <div class="preset-desc">Coming soon ‚Äî add your own JSON</div>
      <div class="preset-chips"><span class="chip chip-lime">soon</span></div>
    </div>
  `).join('');

  el.innerHTML = h;
}
renderPresets();

/* ============================================
   FILE LOADING
   ============================================ */
const uploadBar = document.getElementById('uploadBar');
uploadBar.addEventListener('dragover', e => { e.preventDefault(); uploadBar.style.borderColor = 'var(--lime)'; });
uploadBar.addEventListener('dragleave', () => { uploadBar.style.borderColor = ''; });
uploadBar.addEventListener('drop', e => {
  e.preventDefault(); uploadBar.style.borderColor = '';
  const f = e.dataTransfer.files[0];
  if (f?.name.endsWith('.json')) loadJSONFile(f);
});

function loadFile(e) { const f = e.target.files[0]; if (f) loadJSONFile(f); }

function loadJSONFile(file) {
  const r = new FileReader();
  r.onload = e => {
    try { init(JSON.parse(e.target.result)); }
    catch { toast('Invalid JSON file'); }
  };
  r.readAsText(file);
}

async function loadPreset(path) {
  try {
    const r = await fetch(path);
    if (!r.ok) throw 0;
    init(await r.json());
  } catch { toast('Could not load system'); }
}

/* ============================================
   INIT SYSTEM
   ============================================ */
function init(raw) {
  S.data = raw.system || raw;
  S.inputs = {};
  S.level = 1;

  try {
    const sv = localStorage.getItem('decode-' + S.data.title);
    if (sv) { const p = JSON.parse(sv); S.inputs = p.inputs || {}; S.level = p.level || 1; }
  } catch {}

  document.getElementById('landing').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('hdrActions').style.display = 'flex';
  document.getElementById('bar').classList.add('on');

  renderHead();
  renderXP();
  renderLevels();
  renderCards();
}

function backToMenu() {
  if (!S.data) return;
  saveProgress();
  document.getElementById('landing').style.display = 'block';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('hdrActions').style.display = 'none';
  document.getElementById('bar').classList.remove('on');
  document.getElementById('review').classList.remove('on');
  window.scrollTo(0, 0);
}

/* ============================================
   RENDERERS
   ============================================ */
function renderHead() {
  const d = S.data;
  document.getElementById('sysHead').innerHTML =
    `<h1 class="sys-title">${d.title}</h1>` +
    (d.description ? `<p class="sys-desc">${d.description}</p>` : '');
  document.getElementById('printTitle').textContent = d.title + ' ‚Äî Worksheet';
}

function renderXP() {
  const { filled, total } = countProgress();
  const pct = total > 0 ? Math.round(filled / total * 100) : 100;
  document.getElementById('xpBar').innerHTML = `
    <span class="xp-label">XP</span>
    <div class="xp-track"><div class="xp-fill" style="width:${pct}%"></div></div>
    <span class="xp-pct">${pct}%</span>
  `;
  document.getElementById('barStat').innerHTML = `<b>${filled}</b> / ${total}`;
}

function renderLevels() {
  const descs = S.data.level_descriptions || {};
  const keys = Object.keys(descs).length ? Object.keys(descs) : ['1','2','3'];
  const labels = ['Guided', 'Developing', 'Independent'];

  document.getElementById('lvlStrip').innerHTML = keys.map((k, i) =>
    `<div class="lvl-pill ${parseInt(k)===S.level?'active':''}" onclick="setLevel(${k})">
      <span class="lvl-num">${k}</span> ${labels[i] || 'Level ' + k}
    </div>`
  ).join('');

  const info = document.getElementById('lvlInfo');
  const desc = descs[String(S.level)];
  if (desc) { info.textContent = desc; info.style.display = 'block'; }
  else { info.style.display = 'none'; }

  document.getElementById('printLvl').textContent = S.level;
}

function setLevel(n) {
  S.level = n;
  renderLevels(); renderCards(); renderXP();
  toast('Level ' + n);
}

function renderCards() {
  const comps = S.data.components || [];
  const lv = String(S.level);
  document.getElementById('cards').innerHTML = comps.map((c, i) => {
    const vis = c.level_visibility?.[lv] || {};
    const inp = S.inputs[c.id] || {};
    const num = String(i + 1).padStart(2, '0');

    const np = vis.name !== false && c.name;
    const fp = vis.function !== false && c.function;
    const op = vis.operation !== false && c.operation;
    const ip = vis.image !== false && c.image;

    let filled = 0, total = 0;
    if (!np) { total++; if (inp.name) filled++; }
    if (!fp) { total++; if (inp.function) filled++; }
    if (!op) { total++; if (inp.operation) filled++; }
    if (!ip) { total++; if (inp.image) filled++; }

    let bc = 'badge-todo', bt = 'TO DO';
    if (total === 0) { bc = 'badge-done'; bt = 'PROVIDED'; }
    else if (filled >= total) { bc = 'badge-done'; bt = 'DONE'; }
    else if (filled > 0) { bc = 'badge-wip'; bt = 'WIP'; }

    const done = bc === 'badge-done' ? ' done' : '';
    const hasImg = inp.image || ip;

    return `<div class="card anim${done}" id="c-${c.id}">
      <div class="card-top">
        <span class="card-num">#${num}</span>
        <span class="card-badge ${bc}">${bt}</span>
      </div>
      <div class="card-body">
        <div class="img-zone ${hasImg ? 'has-img' : ''}" onclick="capture('${c.id}')">
          ${inp.image
            ? `<img src="${inp.image}" alt="Photo"><div class="img-rm" onclick="event.stopPropagation();rmImg('${c.id}')">‚úï</div>`
            : ip
              ? `<img src="${c.image}" alt="${c.name||''}"><span class="img-tag">Given</span>`
              : `<div class="img-empty"><div class="img-empty-ico">üì∑</div><div class="img-empty-txt">Tap to snap a photo</div></div>`
          }
        </div>
        ${field(c, 'name', 'Name', np, inp.name)}
        ${field(c, 'function', 'Function', fp, inp.function, true)}
        ${field(c, 'operation', 'Operation', op, inp.operation, true)}
      </div>
    </div>`;
  }).join('');
}

function field(c, key, label, provided, userVal, isTA) {
  let h = `<div class="fld"><div class="fld-label">`;
  h += provided
    ? `<span class="fld-badge">Given</span>`
    : `<span class="fld-dot"></span>`;
  h += ` ${label}</div>`;

  if (provided) {
    h += isTA
      ? `<textarea class="fld-input prov" readonly>${c[key]||''}</textarea>`
      : `<input class="fld-input prov" readonly value="${esc(c[key]||'')}">`;
  } else {
    const v = userVal || '';
    const ph = `Describe the ${label.toLowerCase()}‚Ä¶`;
    h += isTA
      ? `<textarea class="fld-input" placeholder="${ph}" onchange="inp('${c.id}','${key}',this.value)" oninput="inp('${c.id}','${key}',this.value)">${v}</textarea>`
      : `<input class="fld-input" placeholder="${ph}" value="${esc(v)}" onchange="inp('${c.id}','${key}',this.value)" oninput="inp('${c.id}','${key}',this.value)">`;

    if (c.hints?.[key]) {
      const hid = `h-${c.id}-${key}`;
      h += `<button class="hint-btn" onclick="toggleHint('${hid}')">üí° Hint</button>`;
      h += `<div class="hint-box" id="${hid}">${c.hints[key]}</div>`;
    }
  }
  h += '</div>';
  return h;
}

/* ============================================
   INPUT & STATUS
   ============================================ */
function inp(id, key, val) {
  if (!S.inputs[id]) S.inputs[id] = {};
  S.inputs[id][key] = val;
  renderXP();
  updateBadge(id);
}

function updateBadge(id) {
  const c = S.data.components.find(x => x.id === id);
  if (!c) return;
  const vis = c.level_visibility?.[String(S.level)] || {};
  const i = S.inputs[id] || {};
  let f = 0, t = 0;
  ['name','function','operation','image'].forEach(k => {
    if (!(vis[k] !== false && c[k])) { t++; if (i[k]) f++; }
  });
  const el = document.getElementById('c-' + id);
  if (!el) return;
  const b = el.querySelector('.card-badge');
  if (t === 0) { b.className = 'card-badge badge-done'; b.textContent = 'PROVIDED'; el.classList.add('done'); }
  else if (f >= t) { b.className = 'card-badge badge-done'; b.textContent = 'DONE'; el.classList.add('done'); }
  else if (f > 0) { b.className = 'card-badge badge-wip'; b.textContent = 'WIP'; el.classList.remove('done'); }
  else { b.className = 'card-badge badge-todo'; b.textContent = 'TO DO'; el.classList.remove('done'); }
}

function countProgress() {
  const comps = S.data?.components || [];
  const lv = String(S.level);
  let filled = 0, total = 0;
  comps.forEach(c => {
    const vis = c.level_visibility?.[lv] || {};
    const i = S.inputs[c.id] || {};
    ['name','function','operation','image'].forEach(k => {
      if (!(vis[k] !== false && c[k])) { total++; if (i[k]) filled++; }
    });
  });
  return { filled, total };
}

/* ============================================
   IMAGE CAPTURE
   ============================================ */
function capture(id) {
  const c = S.data.components.find(x => x.id === id);
  const vis = c?.level_visibility?.[String(S.level)] || {};
  if (vis.image !== false && c?.image) return;

  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const cv = document.createElement('canvas');
        const mx = 800;
        let w = img.width, h = img.height;
        if (w > mx || h > mx) {
          if (w > h) { h = h/w*mx; w = mx; } else { w = w/h*mx; h = mx; }
        }
        cv.width = w; cv.height = h;
        cv.getContext('2d').drawImage(img, 0, 0, w, h);
        inp(id, 'image', cv.toDataURL('image/jpeg', 0.7));
        renderCards();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function rmImg(id) {
  if (S.inputs[id]) delete S.inputs[id].image;
  renderCards(); renderXP();
}

/* ============================================
   HINTS
   ============================================ */
function toggleHint(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('on');
}

/* ============================================
   CHECK / REVIEW
   ============================================ */
function checkAnswers() {
  const { filled, total } = countProgress();
  const pct = total > 0 ? Math.round(filled / total * 100) : 100;

  document.getElementById('reviewGrid').innerHTML = `
    <div class="review-stat"><div class="review-val">${filled}/${total}</div><div class="review-lbl">Completed</div></div>
    <div class="review-stat"><div class="review-val">${pct}%</div><div class="review-lbl">Progress</div></div>
    <div class="review-stat"><div class="review-val">Lv${S.level}</div><div class="review-lbl">Difficulty</div></div>
  `;
  const rv = document.getElementById('review');
  rv.classList.add('on');
  rv.scrollIntoView({ behavior: 'smooth' });
  toast('Results ready');
}

/* ============================================
   SAVE / RESET / EXPORT
   ============================================ */
function saveProgress() {
  if (!S.data) return;
  try {
    localStorage.setItem('decode-' + S.data.title, JSON.stringify({
      inputs: S.inputs, level: S.level, ts: Date.now()
    }));
    toast('Saved ‚úì');
  } catch { toast('Storage full'); }
}

function resetAnswers() {
  if (!confirm('Clear all your work on this system?')) return;
  S.inputs = {};
  if (S.data) localStorage.removeItem('decode-' + S.data.title);
  renderCards(); renderXP();
  document.getElementById('review').classList.remove('on');
  toast('Cleared');
}

function exportResults() {
  const comps = S.data.components || [];
  const lv = String(S.level);
  let t = `${S.data.title} ‚Äî Learner Responses\nLevel: ${S.level}\nDate: ${new Date().toLocaleDateString('en-GB')}\n${'‚ïê'.repeat(50)}\n\n`;

  comps.forEach((c, i) => {
    const vis = c.level_visibility?.[lv] || {};
    const inp = S.inputs[c.id] || {};
    t += `${i+1}. ${c.name || inp.name || '[Unnamed]'}\n${'‚îÄ'.repeat(40)}\n`;
    ['name','function','operation'].forEach(k => {
      const lbl = k.charAt(0).toUpperCase() + k.slice(1);
      t += (vis[k] !== false && c[k])
        ? `${lbl} (given): ${c[k]}\n`
        : `${lbl} (learner): ${inp[k] || '[Not completed]'}\n`;
    });
    t += `Photo: ${inp.image ? 'Yes' : 'No'}\n\n`;
  });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([t], { type: 'text/plain' }));
  a.download = S.data.title.replace(/\s+/g, '-').toLowerCase() + '-responses.txt';
  a.click();
  toast('Exported ‚úì');
}

/* ============================================
   LEVEL MODAL
   ============================================ */
function showLevelModal() {
  const descs = S.data.level_descriptions || {};
  const labels = ['Guided', 'Developing', 'Independent'];
  let h = '<h3>DIFFICULTY</h3><div style="display:flex;gap:0.4rem;margin-bottom:1rem;">';
  [1,2,3].forEach((n, i) => {
    h += `<div class="lvl-pill ${n===S.level?'active':''}" style="flex:1;justify-content:center;" onclick="setLevel(${n});closeLvlModal();">
      <span class="lvl-num">${n}</span> ${labels[i]}
    </div>`;
  });
  h += '</div>';
  Object.entries(descs).forEach(([k, v]) => {
    h += `<p style="font-size:0.8rem;color:var(--text-mid);margin-bottom:0.5rem;line-height:1.5;"><strong style="color:var(--lime);">Level ${k}</strong> ‚Äî ${v}</p>`;
  });
  h += '<div style="margin-top:1rem;text-align:right;"><button class="btn btn-ghost btn-sm" onclick="closeLvlModal()">Close</button></div>';
  document.getElementById('lvlModalBox').innerHTML = h;
  document.getElementById('lvlModal').classList.add('on');
}

function closeLvlModal() { document.getElementById('lvlModal').classList.remove('on'); }

/* ============================================
   UTILS
   ============================================ */
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('on');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('on'), 2200);
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

document.getElementById('lvlModal').addEventListener('click', function(e) { if (e.target === this) closeLvlModal(); });

// URL auto-load
(function() {
  const p = new URLSearchParams(location.search).get('system');
  if (p) loadPreset(p);
})();
</script>
</body>
</html>
